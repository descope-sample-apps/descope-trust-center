name: OpenCode Merge

on:
  repository_dispatch:
    types: [opencode-merge]

permissions:
  contents: write
  issues: write
  pull-requests: write
  models: read

jobs:
  merge:
    runs-on: ubuntu-latest
    outputs:
      has_conflicts: ${{ steps.merge-branches.outputs.has_conflicts }}
      pr_number: ${{ steps.create-pr.outputs.pr_number }}
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout feature branch
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.client_payload.branch }}
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0

      - name: Setup git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge all task sub-branches
        id: merge-branches
        env:
          FEATURE_BRANCH: ${{ github.event.client_payload.branch }}
          TASK_IDS: ${{ toJson(github.event.client_payload.task_ids) }}
        run: |
          echo "Merging task sub-branches into $FEATURE_BRANCH..."

          TASK_IDS_ARRAY=$(echo "$TASK_IDS" | jq -r '.[]')
          CONFLICTS=""
          MERGED=""

          for TASK_ID in $TASK_IDS_ARRAY; do
            SUB_BRANCH="${FEATURE_BRANCH}/${TASK_ID}"
            echo "Processing: $SUB_BRANCH"
            
            # Check if branch exists
            if git ls-remote --heads origin "$SUB_BRANCH" | grep -q "$SUB_BRANCH"; then
              git fetch origin "$SUB_BRANCH"
              
              # Try to merge
              if git merge "origin/$SUB_BRANCH" --no-edit -m "Merge task $TASK_ID"; then
                echo "âœ“ Merged $SUB_BRANCH"
                MERGED="$MERGED $TASK_ID"
              else
                echo "âœ— Conflict in $SUB_BRANCH"
                CONFLICTS="$CONFLICTS $TASK_ID"
                git merge --abort
              fi
            else
              echo "âš  Branch $SUB_BRANCH not found (task may have had no changes)"
            fi
          done

          if [ -n "$CONFLICTS" ]; then
            echo "has_conflicts=true" >> $GITHUB_OUTPUT
            echo "conflict_tasks=$CONFLICTS" >> $GITHUB_OUTPUT
          else
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
          fi

          echo "merged_tasks=$MERGED" >> $GITHUB_OUTPUT

      - name: Push merged feature branch
        if: steps.merge-branches.outputs.has_conflicts != 'true'
        run: |
          git push origin ${{ github.event.client_payload.branch }}

      - name: Create Pull Request
        id: create-pr
        if: steps.merge-branches.outputs.has_conflicts != 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const issueNumber = context.payload.client_payload.issue_number;
            const branch = context.payload.client_payload.branch;
            const taskIds = context.payload.client_payload.task_ids;

            // Get issue details for PR title/body
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            const taskList = taskIds.map(id => `- \`${id}\``).join('\n');

            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ¤– ${issue.title}`,
              body: `## Summary

            Automated implementation for #${issueNumber}

            ## Tasks Completed

            ${taskList}

            ---

            Closes #${issueNumber}`,
              head: branch,
              base: 'main'
            });

            console.log(`Created PR #${pr.number}`);
            core.setOutput('pr_number', pr.number);

            // Comment on the issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `## ðŸŽ‰ Implementation Complete

            Pull Request: #${pr.number}

            All ${taskIds.length} task(s) have been merged and are ready for review.`
            });

      - name: Cleanup task sub-branches
        if: steps.merge-branches.outputs.has_conflicts != 'true'
        env:
          FEATURE_BRANCH: ${{ github.event.client_payload.branch }}
          TASK_IDS: ${{ toJson(github.event.client_payload.task_ids) }}
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          TASK_IDS_ARRAY=$(echo "$TASK_IDS" | jq -r '.[]')

          for TASK_ID in $TASK_IDS_ARRAY; do
            SUB_BRANCH="${FEATURE_BRANCH}/${TASK_ID}"
            echo "Deleting: $SUB_BRANCH"
            git push origin --delete "$SUB_BRANCH" 2>/dev/null || echo "Branch $SUB_BRANCH already deleted or doesn't exist"
          done

  resolve-conflicts:
    needs: merge
    if: needs.merge.outputs.has_conflicts == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout feature branch
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.client_payload.branch }}
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0

      - name: Setup tools
        run: |
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Setup git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Post conflict notification
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.client_payload.issue_number,
              body: `### âš ï¸ Merge Conflicts Detected

            Some task branches have conflicts. Sisyphus will attempt to resolve them...`
            });

      - name: Resolve conflicts with Sisyphus
        env:
          FEATURE_BRANCH: ${{ github.event.client_payload.branch }}
          TASK_IDS: ${{ toJson(github.event.client_payload.task_ids) }}
        run: |
          curl -fsSL https://opencode.ai/install | bash
          export PATH="$HOME/.opencode/bin:$HOME/.local/bin:$PATH"

          mkdir -p ~/.config/opencode
          echo '{"plugin":["oh-my-opencode"]}' > ~/.config/opencode/opencode.json

          TASK_IDS_ARRAY=$(echo "$TASK_IDS" | jq -r '.[]')

          for TASK_ID in $TASK_IDS_ARRAY; do
            SUB_BRANCH="${FEATURE_BRANCH}/${TASK_ID}"
            
            if git ls-remote --heads origin "$SUB_BRANCH" | grep -q "$SUB_BRANCH"; then
              git fetch origin "$SUB_BRANCH"
              
              if ! git merge "origin/$SUB_BRANCH" --no-edit -m "Merge task $TASK_ID" 2>/dev/null; then
                echo "Resolving conflicts for $TASK_ID..."
                
                # Get list of conflicted files
                CONFLICTED=$(git diff --name-only --diff-filter=U)
                
                opencode run "
                Resolve merge conflicts in the following files:
                
                $CONFLICTED
                
                ## Instructions
                1. Look at the conflict markers (<<<<<<, =======, >>>>>>)
                2. Understand both versions of the code
                3. Merge them intelligently, keeping functionality from both sides
                4. Remove all conflict markers
                5. The code must compile and work correctly
                
                After resolving, stage the files with 'git add'.
                " || true
                
                # If still unresolved, take the incoming changes
                git checkout --theirs . 2>/dev/null || true
                git add -A
                git commit -m "Merge task $TASK_ID (conflicts resolved)" || true
              fi
            fi
          done

      - name: Push resolved branch
        run: |
          git push origin ${{ github.event.client_payload.branch }}

      - name: Retry merge dispatch
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            // Dispatch merge again after conflict resolution
            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'opencode-merge',
              client_payload: {
                issue_number: context.payload.client_payload.issue_number,
                branch: context.payload.client_payload.branch,
                task_ids: context.payload.client_payload.task_ids
              }
            });
