name: OpenCode Agent

on:
  schedule:
    - cron: "0 * * * *" # Every hour
  workflow_dispatch:
    inputs:
      task:
        description: "Specific task to work on (leave empty to auto-pick)"
        required: false
        type: string
      skip_pr_review:
        description: "Skip PR review handling"
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: opencode-agent
  cancel-in-progress: false

env:
  FORCE_COLOR: 3

jobs:
  agent:
    runs-on: ubuntu-latest
    timeout-minutes: 55
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0

      - name: Setup mise
        uses: jdx/mise-action@c37c93293d6b742fc901e1406b8f764f6fb19dac # v2
        with:
          install: true
          cache: true

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Copy env
        run: cp .env.example .env

      - name: Configure Git
        run: |
          git config user.name "opencode-agent[bot]"
          git config user.email "opencode-agent[bot]@users.noreply.github.com"

      - name: Handle PR Reviews
        if: ${{ inputs.skip_pr_review != true }}
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          echo "ðŸ” Checking for PRs with pending reviews..."

          # Find PRs with copilot reviews that need attention
          prs_with_reviews=$(gh pr list --state open --json number,headRefName,reviews --jq '
            [.[] | select(.reviews | length > 0) | {
              number: .number,
              branch: .headRefName,
              has_changes_requested: ([.reviews[] | select(.state == "CHANGES_REQUESTED")] | length > 0)
            }] | .[]
          ')

          if [ -z "$prs_with_reviews" ]; then
            echo "No PRs with pending reviews found"
          else
            echo "Found PRs with reviews - will be handled by opencode"
            echo "$prs_with_reviews"
          fi

      - name: Run OpenCode Agent
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Build the prompt based on inputs
          if [ -n "${{ inputs.task }}" ]; then
            PROMPT="${{ inputs.task }}"
          else
            PROMPT=$(cat <<'PROMPT_EOF'
          You are an autonomous AI agent working on the Descope Trust Center repository.

          ## Your Mission

          Complete ONE of the following tasks in priority order:

          ### Task 1: Handle PR Reviews (if any exist)
          1. Run: `gh pr list --state open --json number,headRefName,title,reviews`
          2. For each PR with reviews (especially from Copilot):
             - Check out the PR branch: `git checkout <branch>`
             - Read the review comments: `gh pr view <number> --comments`
             - For each comment that needs addressing:
               a. Understand the feedback
               b. Make the necessary code changes
               c. Reply to the comment explaining what you fixed
               d. Resolve the comment using GraphQL:
                  ```
                  gh api graphql -f query='
                    mutation {
                      resolveReviewThread(input: {threadId: "<thread_id>"}) {
                        thread { isResolved }
                      }
                    }
                  '
                  ```
             - Commit and push: `git add . && git commit -m "fix: address review feedback" && git push`
             - Keep iterating until all comments are resolved

          ### Task 2: Pick Up a New Issue (if no PR reviews)
          1. Find available tasks:
             ```
             gh issue list --state open --label "P0-critical" --json number,title,labels
             gh issue list --state open --label "P1-high" --json number,title,labels
             gh issue list --state open --label "opencode" --json number,title,labels
             ```
          2. Skip issues with the `blocked` label
          3. Pick the highest priority unblocked issue
          4. Claim it:
             - Add comment: "ðŸ¤– OpenCode agent starting work on this issue"
             - Add `opencode` label if not present
          5. Create a feature branch: `git checkout -b feat/<issue-slug>`
          6. Implement the solution following AGENTS.md guidelines
          7. Run checks: `pnpm typecheck && pnpm lint && pnpm test`
          8. Commit with conventional format: `git commit -m "feat(<scope>): <description>\n\nCloses #<issue>"`
          9. Push and create PR:
             ```
             git push -u origin HEAD
             gh pr create --title "<title>" --body "<description>\n\nCloses #<issue>"
             ```

          ## Important Rules
          - Only work on ONE task per run
          - Always run `pnpm typecheck` before committing
          - Follow existing code patterns from AGENTS.md
          - Use `zod/v4` not `zod`
          - Use `import { env } from "~/env"` not `process.env`
          - Never suppress TypeScript errors
          - If blocked, add `blocked` label and move to next task

          ## Getting Review Thread IDs
          To resolve comments, first get the thread IDs:
          ```
          gh api graphql -f query='
            query($owner: String!, $repo: String!, $pr: Int!) {
              repository(owner: $owner, name: $repo) {
                pullRequest(number: $pr) {
                  reviewThreads(first: 100) {
                    nodes {
                      id
                      isResolved
                      comments(first: 1) {
                        nodes { body }
                      }
                    }
                  }
                }
              }
            }
          ' -f owner="${{ github.repository_owner }}" -f repo="${{ github.event.repository.name }}" -F pr=<PR_NUMBER>
          ```

          Start now. Pick one task and complete it.
          PROMPT_EOF
          )
          fi

          echo "ðŸ¤– Starting OpenCode agent..."
          echo "Prompt: ${PROMPT:0:200}..."

          # Run opencode with the prompt
          opencode --yes --prompt "$PROMPT"

      - name: Report Status
        if: always()
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          echo "ðŸ“Š Agent run completed"
          echo "Exit code: $?"

          # Check if any PRs were created
          recent_prs=$(gh pr list --state open --author "opencode-agent[bot]" --json number,title,url --jq '.[] | "PR #\(.number): \(.title) - \(.url)"')
          if [ -n "$recent_prs" ]; then
            echo "ðŸ“¬ Recent PRs by agent:"
            echo "$recent_prs"
          fi

          # Check for any remaining open issues
          open_issues=$(gh issue list --state open --label "P0-critical,P1-high" --json number,title --jq 'length')
          echo "ðŸ“‹ Remaining high-priority issues: $open_issues"
