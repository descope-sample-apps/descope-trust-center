name: OpenCode Agent

on:
  schedule:
    - cron: "0 * * * *" # Every hour
  workflow_dispatch:
    inputs:
      task:
        description: "Specific task to work on"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: opencode-agent
  cancel-in-progress: false

env:
  FORCE_COLOR: 3

jobs:
  agent:
    runs-on: ubuntu-latest
    timeout-minutes: 55
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0

      - name: Setup mise
        uses: jdx/mise-action@c37c93293d6b742fc901e1406b8f764f6fb19dac # v2
        with:
          install: true
          cache: true

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Copy env
        run: cp .env.example .env

      - name: Configure Git
        run: |
          git config user.name "opencode-agent[bot]"
          git config user.email "opencode-agent[bot]@users.noreply.github.com"

      - name: Run OpenCode Agent
        id: run-agent
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Use custom task if provided, otherwise use the standard workflow
          if [ -n "${{ inputs.task }}" ]; then
            PROMPT="${{ inputs.task }}"
          else
            PROMPT=$(cat <<'EOF'
          You are an autonomous AI agent working on the Descope Trust Center repository.

          Handle ONE task from highest to lowest priority:

          1. PR REVIEWS: If there are open PRs with unresolved review comments, pick one and address all the comments. Check out the branch, read comments, make fixes, reply to comments, resolve threads, commit and push.

          2. ISSUES: If no PR reviews, pick the highest priority open issue (P0 > P1 > P2 > P3 > unlabeled) without 'blocked' label. Claim it, implement the solution following AGENTS.md patterns, run checks, create PR.

          Rules:
          - Work on exactly ONE task per run
          - Use conventional commits and proper PR descriptions
          - Run 'pnpm typecheck && pnpm lint && (pnpm test || echo "Tests may fail in CI")' before committing
          - Follow existing code patterns from AGENTS.md
          - Use zod/v4, import { env } from '~/env', never suppress TS errors
          - For PR reviews: resolve all comments in one go, don't leave partial work
          - Always check git status and commit all changes before pushing
          EOF
          )
          fi

          echo "ðŸ¤– Starting OpenCode agent..."
          echo "Prompt: ${PROMPT:0:200}..."

          # Run opencode with the prompt and capture exit code
          set +e
          opencode --yes --prompt "$PROMPT"
          OPENCODE_EXIT=$?
          set -e

          echo "opencode_exit=$OPENCODE_EXIT" >> $GITHUB_OUTPUT

          if [ $OPENCODE_EXIT -ne 0 ]; then
            echo "::error::OpenCode agent failed with exit code $OPENCODE_EXIT"
          fi

      - name: Report Status
        if: always()
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          OPENCODE_EXIT: ${{ steps.run-agent.outputs.opencode_exit || '0' }}
        run: |
          echo "ðŸ“Š Agent run completed"
          echo "Exit code: $OPENCODE_EXIT"

          # Check for any PRs were created
          recent_prs=$(gh pr list --state open --author "opencode-agent[bot]" --json number,title,url --jq '.[] | "PR #\(.number): \(.title) - \(.url)"')
          if [ -n "$recent_prs" ]; then
            echo "ðŸ“¬ Recent PRs by agent:"
            echo "$recent_prs"
          fi

          # Check for any remaining open issues
          open_issues=$(gh issue list --state open --label "P0-critical,P1-high" --json number,title --jq 'length')
          echo "ðŸ“‹ Remaining high-priority issues: $open_issues"
