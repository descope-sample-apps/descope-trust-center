name: OpenCode Batch Workers

on:
  repository_dispatch:
    types: [opencode-batch]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number'
        required: true
        type: number
      branch:
        description: 'Feature branch name'
        required: true
        type: string

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  coordinator:
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Set payload variables
        id: payload
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "issue_number=${{ inputs.issue_number }}" >> $GITHUB_OUTPUT
            echo "branch=${{ inputs.branch }}" >> $GITHUB_OUTPUT
          else
            echo "issue_number=${{ github.event.client_payload.issue_number }}" >> $GITHUB_OUTPUT
            echo "branch=${{ github.event.client_payload.branch }}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout feature branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.payload.outputs.branch }}
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0

      - name: Setup tools
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          mkdir -p "$HOME/.local/bin"
          
          # Install beads
          gh release download --repo steveyegge/beads --pattern 'beads_*_linux_amd64.tar.gz' --output /tmp/beads.tar.gz
          tar -xzf /tmp/beads.tar.gz -C /tmp && mv /tmp/bd "$HOME/.local/bin/" && rm -rf /tmp/beads.tar.gz /tmp/bd
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
          # Install bun
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH
          
          # Install opencode
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
          
          # Install bun dependencies
          $HOME/.bun/bin/bun install

      - name: Setup git and beads
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Configure beads sync branch
          sed -i 's/^# sync-branch:.*/sync-branch: "beads-sync"/' .beads/config.yaml || echo 'sync-branch: "beads-sync"' >> .beads/config.yaml
          
          # Initialize and sync beads
          "$HOME/.local/bin/bd" init
          "$HOME/.local/bin/bd" sync

      - name: Post started comment
        id: comment
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const { data: comment } = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ steps.payload.outputs.issue_number }}'),
              body: '### üîÑ Implementation Started\n\nSisyphus is implementing all tasks, merging branches, and will create a PR when complete...'
            });
            return comment.id;
          result-encoding: string

      - name: Run Sisyphus Coordinator
        id: sisyphus
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          FEATURE_BRANCH: ${{ steps.payload.outputs.branch }}
          ISSUE_NUMBER: ${{ steps.payload.outputs.issue_number }}
        run: |
          # Run Sisyphus with the coordinator prompt
          opencode run \
            --model "opencode/big-pickle" \
            "# EPIC COORDINATOR - Implement All Tasks, Merge, and Create PR

          You are the EPIC COORDINATOR. Your job is to:
          1. Implement ALL tasks in waves (parallel subagents per batch)
          2. Merge all task branches into the feature branch
          3. Create a Pull Request
          4. Clean up task branches

          ## Environment
          - Feature branch: $FEATURE_BRANCH
          - Issue number: $ISSUE_NUMBER
          - Tools available: bd, bun, git, gh

          ---

          # PHASE 1: IMPLEMENT ALL TASKS

          ## Step 1: Check Ready Tasks
          \`\`\`bash
          bd ready --json
          \`\`\`

          ## Step 2: Spawn Parallel Subagents for Ready Tasks
          For EACH ready task, spawn a subagent using Task tool with subagent_type=\"general\".
          
          **CRITICAL**: Spawn ALL ready tasks in ONE message with MULTIPLE Task calls for parallelism.

          Each subagent prompt:
          \`\`\`
          Implement this task on branch $FEATURE_BRANCH:

          Task ID: <id>
          Task Title: <title>

          ## Instructions
          1. git checkout $FEATURE_BRANCH && git pull origin $FEATURE_BRANCH
          2. git checkout -b \"$FEATURE_BRANCH-task-<id>\"
          3. bd update <id> --status in_progress && bd sync -m \"start <id>\"
          4. Implement the task following existing code patterns
          5. bun run build (must pass)
          6. git add -A && git commit -m \"feat(<id>): <title>\"
          7. git push -u origin \"$FEATURE_BRANCH-task-<id>\"
          8. bd close <id> && bd sync -m \"complete <id>\"
          9. git checkout $FEATURE_BRANCH

          Report what was implemented.
          \`\`\`

          ## Step 3: After Subagents Complete
          \`\`\`bash
          bd sync
          bd ready --json
          \`\`\`
          If more tasks ready ‚Üí repeat Step 2
          If none ready ‚Üí check if all closed with \`bd list --json\`

          ## Step 4: Verify All Tasks Closed
          ALL tasks must have status \"closed\" before proceeding to Phase 2.

          ---

          # PHASE 2: MERGE ALL TASK BRANCHES

          After ALL tasks are closed:

          \`\`\`bash
          git checkout $FEATURE_BRANCH
          git pull origin $FEATURE_BRANCH
          \`\`\`

          Get list of task branches:
          \`\`\`bash
          git fetch --all
          git branch -r | grep \"$FEATURE_BRANCH-task-\" | sed 's|origin/||'
          \`\`\`

          For each task branch, merge into feature branch:
          \`\`\`bash
          git merge origin/<task-branch> --no-edit -m \"Merge <task-id>\"
          \`\`\`

          If conflicts occur:
          1. Examine conflicted files
          2. Resolve conflicts intelligently (keep functionality from both sides)
          3. Remove conflict markers
          4. git add -A && git commit -m \"Merge <task-id> (resolved conflicts)\"

          After all merges:
          \`\`\`bash
          git push origin $FEATURE_BRANCH
          \`\`\`

          ---

          # PHASE 3: CREATE PULL REQUEST

          Use gh CLI to create the PR:
          \`\`\`bash
          gh pr create \\
            --base main \\
            --head $FEATURE_BRANCH \\
            --title \"ü§ñ <issue title>\" \\
            --body \"## Summary

          Automated implementation for #$ISSUE_NUMBER

          ## Tasks Completed
          <list task IDs and titles>

          ---
          Closes #$ISSUE_NUMBER\"
          \`\`\`

          Save the PR number from the output.

          ---

          # PHASE 4: CLEANUP TASK BRANCHES

          Delete all task sub-branches:
          \`\`\`bash
          git push origin --delete \"<task-branch>\"
          \`\`\`

          ---

          # COMPLETION

          When everything is done, output EXACTLY:
          \`\`\`
          EPIC_COMPLETE: true
          PR_NUMBER: <number>
          \`\`\`

          If any phase fails unrecoverably:
          \`\`\`
          EPIC_COMPLETE: false
          ERROR: <description>
          \`\`\`

          ## Important Rules
          1. Each subagent works on its OWN task branch (no conflicts during implementation)
          2. Use bd sync after EVERY status change
          3. If a subagent fails, note it but continue with others
          4. Resolve merge conflicts - don't give up
          5. The PR must be created before you're done" 2>&1 | tee /tmp/sisyphus-output.txt
          
          # Parse output for results
          if grep -q "EPIC_COMPLETE: true" /tmp/sisyphus-output.txt; then
            echo "epic_complete=true" >> $GITHUB_OUTPUT
            PR_NUM=$(grep "PR_NUMBER:" /tmp/sisyphus-output.txt | sed 's/PR_NUMBER: //' | tr -d ' ')
            echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
          else
            echo "epic_complete=false" >> $GITHUB_OUTPUT
          fi

      - name: Update comment with result
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const epicComplete = '${{ steps.sisyphus.outputs.epic_complete }}' === 'true';
            const prNumber = '${{ steps.sisyphus.outputs.pr_number }}';
            const commentId = parseInt('${{ steps.comment.outputs.result }}');
            
            let body;
            if (epicComplete && prNumber) {
              body = `### üéâ Implementation Complete\n\nAll tasks implemented and merged.\n\n**Pull Request:** #${prNumber}`;
            } else if (epicComplete) {
              body = '### ‚úÖ All Tasks Complete\n\nAll tasks have been implemented and merged. Check for the PR.';
            } else {
              body = '### ‚ö†Ô∏è Implementation Finished with Issues\n\nSome tasks may have failed. Check workflow logs for details.';
            }
            
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });
