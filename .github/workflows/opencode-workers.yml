name: OpenCode Batch Workers

on:
  repository_dispatch:
    types: [opencode-batch]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number'
        required: true
        type: number
      branch:
        description: 'Feature branch name'
        required: true
        type: string

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  coordinator:
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Set payload variables
        id: payload
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "issue_number=${{ inputs.issue_number }}" >> $GITHUB_OUTPUT
            echo "branch=${{ inputs.branch }}" >> $GITHUB_OUTPUT
          else
            echo "issue_number=${{ github.event.client_payload.issue_number }}" >> $GITHUB_OUTPUT
            echo "branch=${{ github.event.client_payload.branch }}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout feature branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.payload.outputs.branch }}
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0

      - name: Setup tools
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          mkdir -p "$HOME/.local/bin"
          
          # Install beads
          gh release download --repo steveyegge/beads --pattern 'beads_*_linux_amd64.tar.gz' --output /tmp/beads.tar.gz
          tar -xzf /tmp/beads.tar.gz -C /tmp && mv /tmp/bd "$HOME/.local/bin/" && rm -rf /tmp/beads.tar.gz /tmp/bd
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
          # Install bun
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH
          
          # Install opencode
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
          
          # Install bun dependencies
          $HOME/.bun/bin/bun install

      - name: Setup git and beads
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Configure beads sync branch
          sed -i 's/^# sync-branch:.*/sync-branch: "beads-sync"/' .beads/config.yaml || echo 'sync-branch: "beads-sync"' >> .beads/config.yaml
          
          # Initialize and sync beads
          "$HOME/.local/bin/bd" init
          "$HOME/.local/bin/bd" sync

      - name: Post batch started comment
        id: comment
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const { data: comment } = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ steps.payload.outputs.issue_number }}'),
              body: '### ðŸ”„ Batch Processing Started\n\nSisyphus coordinator is processing tasks...'
            });
            return comment.id;
          result-encoding: string

      - name: Run Sisyphus Coordinator
        id: sisyphus
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Create a comprehensive prompt for Sisyphus
          cat > /tmp/coordinator-prompt.md << 'PROMPT_EOF'
          # BATCH COORDINATOR - Process All Tasks Until Epic Complete

          You are the BATCH COORDINATOR. Your job is to process ALL tasks in the beads database
          until the epic is complete. You will work in waves, spawning parallel subagents for
          each batch of ready tasks.

          ## Environment
          - Feature branch: $FEATURE_BRANCH
          - Issue number: $ISSUE_NUMBER
          - All tools are available: bd, bun, git

          ## Your Workflow (LOOP until done)

          ### Step 1: Check Ready Tasks
          ```bash
          bd ready --json
          ```
          This returns tasks with NO blockers (dependencies satisfied).

          ### Step 2: If Tasks Ready â†’ Spawn Parallel Subagents
          For EACH ready task, spawn a subagent using the Task tool with subagent_type="general".
          
          **CRITICAL**: Spawn ALL ready tasks in a SINGLE message with MULTIPLE Task tool calls.
          This ensures true parallel execution.

          Each subagent prompt MUST include:
          ```
          Implement this task:
          
          Task ID: <id>
          Task Title: <title>
          
          ## Instructions
          1. Create task branch: git checkout -b "$FEATURE_BRANCH-task-<id>"
          2. Mark task in progress: bd update <id> --status in_progress && bd sync -m "start <id>"
          3. Implement the task following existing code patterns
          4. Run: bun run build (must pass)
          5. Commit changes: git add -A && git commit -m "feat(<id>): <title>"
          6. Push branch: git push -u origin "$FEATURE_BRANCH-task-<id>"
          7. Close task: bd close <id> && bd sync -m "complete <id>"
          8. Return to feature branch: git checkout $FEATURE_BRANCH
          
          Report what was implemented when done.
          ```

          ### Step 3: Wait for All Subagents
          After spawning, wait for all subagents to complete and collect their results.

          ### Step 4: Sync and Check for More
          ```bash
          bd sync  # Get latest task states
          bd ready --json  # Check if more tasks are now unblocked
          ```

          If more tasks are ready â†’ Go to Step 2
          If no more tasks ready â†’ Check if epic is complete

          ### Step 5: Verify Epic Complete
          ```bash
          bd list --json
          ```
          Check if ALL tasks have status "closed". If yes, you're done!
          If some tasks are still open but none are ready, there may be a dependency issue.

          ## Completion Criteria
          - ALL tasks in beads have status "closed"
          - All task branches pushed to remote
          - bd sync completed (beads state saved)

          ## Output When Done
          When all tasks are complete, output EXACTLY this line (for parsing):
          ```
          EPIC_COMPLETE: true
          ```

          If there's an error or tasks are stuck:
          ```
          EPIC_COMPLETE: false
          ERROR: <description of what went wrong>
          ```

          ## Important Rules
          1. NEVER modify the feature branch directly - only task sub-branches
          2. Each subagent works on its OWN branch (no conflicts)
          3. Use bd sync after EVERY status change
          4. If a subagent fails, note it but continue with others
          5. Keep going until ALL tasks are closed or you hit an unrecoverable error
          PROMPT_EOF

          # Replace variables in prompt
          sed -i "s|\$FEATURE_BRANCH|${{ steps.payload.outputs.branch }}|g" /tmp/coordinator-prompt.md
          sed -i "s|\$ISSUE_NUMBER|${{ steps.payload.outputs.issue_number }}|g" /tmp/coordinator-prompt.md

          # Run Sisyphus with the coordinator prompt
          RESULT=$(opencode run \
            --model "opencode/big-pickle" \
            --print-only \
            "$(cat /tmp/coordinator-prompt.md)")
          
          echo "$RESULT"
          
          # Check if epic complete
          if echo "$RESULT" | grep -q "EPIC_COMPLETE: true"; then
            echo "epic_complete=true" >> $GITHUB_OUTPUT
          else
            echo "epic_complete=false" >> $GITHUB_OUTPUT
          fi

      - name: Update comment with result
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const epicComplete = '${{ steps.sisyphus.outputs.epic_complete }}' === 'true';
            const commentId = parseInt('${{ steps.comment.outputs.result }}');
            
            let body;
            if (epicComplete) {
              body = '### âœ… All Tasks Complete\n\nAll tasks have been implemented. Dispatching merge workflow...';
            } else {
              body = '### âš ï¸ Batch Processing Finished\n\nSome tasks may have failed. Check workflow logs for details.';
            }
            
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

      - name: Dispatch merge
        if: steps.sisyphus.outputs.epic_complete == 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            // Get all task IDs for merge workflow
            const { execSync } = require('child_process');
            const tasksJson = execSync('bd list --json 2>/dev/null || echo "[]"').toString();
            const tasks = JSON.parse(tasksJson);
            const taskIds = tasks.map(t => t.id);
            
            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'opencode-merge',
              client_payload: {
                issue_number: parseInt('${{ steps.payload.outputs.issue_number }}'),
                branch: '${{ steps.payload.outputs.branch }}',
                task_ids: taskIds
              }
            });
            
            console.log('Dispatched merge workflow with task IDs:', taskIds);
