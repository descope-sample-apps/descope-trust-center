name: OpenCode Batch Workers

on:
  repository_dispatch:
    types: [opencode-batch]
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  get-ready-tasks:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.ready.outputs.matrix }}
      has_tasks: ${{ steps.ready.outputs.has_tasks }}
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout feature branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.branch }}
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0

      - name: Setup beads
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          mkdir -p "$HOME/.local/bin"
          gh release download --repo steveyegge/beads --pattern 'beads_*_linux_amd64.tar.gz' --output /tmp/beads.tar.gz
          tar -xzf /tmp/beads.tar.gz -C /tmp && mv /tmp/bd "$HOME/.local/bin/" && rm -rf /tmp/beads.tar.gz /tmp/bd
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          sed -i 's/^# sync-branch:.*/sync-branch: "beads-sync"/' .beads/config.yaml || echo 'sync-branch: "beads-sync"' >> .beads/config.yaml
          "$HOME/.local/bin/bd" init

      - name: Sync beads state
        run: |
          bd sync

      - name: Get ready tasks
        id: ready
        run: |
          READY=$(bd ready --json 2>/dev/null || echo "[]")
          echo "Raw ready output: $READY"

          if [ "$READY" = "[]" ] || [ -z "$READY" ]; then
            echo "has_tasks=false" >> $GITHUB_OUTPUT
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
          else
            # Transform to GitHub Actions matrix format
            MATRIX=$(echo "$READY" | jq -c '{include: .}')
            echo "has_tasks=true" >> $GITHUB_OUTPUT
            echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          fi

  worker:
    needs: get-ready-tasks
    if: needs.get-ready-tasks.outputs.has_tasks == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix: ${{ fromJson(needs.get-ready-tasks.outputs.matrix) }}
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout feature branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.branch }}
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0

      - name: Setup tools
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          mkdir -p "$HOME/.local/bin"
          gh release download --repo steveyegge/beads --pattern 'beads_*_linux_amd64.tar.gz' --output /tmp/beads.tar.gz
          tar -xzf /tmp/beads.tar.gz -C /tmp && mv /tmp/bd "$HOME/.local/bin/" && rm -rf /tmp/beads.tar.gz /tmp/bd
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          sed -i 's/^# sync-branch:.*/sync-branch: "beads-sync"/' .beads/config.yaml || echo 'sync-branch: "beads-sync"' >> .beads/config.yaml
          "$HOME/.local/bin/bd" init

      - name: Sync beads state
        run: |
          bd sync

      - name: Create task sub-branch
        id: branch
        run: |
          TASK_ID="${{ matrix.id }}"
          FEATURE_BRANCH="${{ github.event.client_payload.branch }}"
          SUB_BRANCH="${FEATURE_BRANCH}-task-${TASK_ID}"
          git checkout -b "$SUB_BRANCH"
          echo "sub_branch=$SUB_BRANCH" >> $GITHUB_OUTPUT
          echo "task_id=$TASK_ID" >> $GITHUB_OUTPUT

      - name: Update task status to in-progress
        run: |
          bd update "${{ matrix.id }}" --status in_progress
          bd sync -m "chore: start task ${{ matrix.id }}"

      - name: Run OpenCode Sisyphus Agent
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          opencode run \
            --model "opencode/big-pickle" \
            "Implement task: ${{ matrix.title || matrix.summary }}

          Task ID: ${{ matrix.id }}

          ## Instructions
          1. Implement only this specific task
          2. Follow existing code patterns
          3. Run 'bun run build' to verify no errors
          4. Make focused, atomic changes

          When complete, summarize what was implemented."

      - name: Close task
        run: |
          bd close "${{ matrix.id }}"
          bd sync -m "chore: complete task ${{ matrix.id }}"

      - name: Commit and push changes
        run: |
          git add -A
          if ! git diff --staged --quiet; then
            git commit -m "feat(${{ matrix.id }}): ${{ matrix.title || matrix.summary }}"
            git push -u origin "${{ steps.branch.outputs.sub_branch }}"
          fi

  check-next:
    needs: [get-ready-tasks, worker]
    if: always() && needs.get-ready-tasks.outputs.has_tasks == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout feature branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.branch }}
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0

      - name: Setup beads
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          mkdir -p "$HOME/.local/bin"
          gh release download --repo steveyegge/beads --pattern 'beads_*_linux_amd64.tar.gz' --output /tmp/beads.tar.gz
          tar -xzf /tmp/beads.tar.gz -C /tmp && mv /tmp/bd "$HOME/.local/bin/" && rm -rf /tmp/beads.tar.gz /tmp/bd
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          "$HOME/.local/bin/bd" init
          sed -i 's/^# sync-branch:.*/sync-branch: "beads-sync"/' .beads/config.yaml || echo 'sync-branch: "beads-sync"' >> .beads/config.yaml

      - name: Sync beads state
        run: |
          bd sync

      - name: Check for more ready tasks
        id: check
        run: |
          READY=$(bd ready --json 2>/dev/null || echo "[]")
          READY_COUNT=$(echo "$READY" | jq 'length')

          # Get all tasks to collect IDs for merge
          ALL_TASKS=$(bd list --json 2>/dev/null || echo "[]")
          TASK_IDS=$(echo "$ALL_TASKS" | jq -c '[.[].id]')

          echo "ready_count=$READY_COUNT" >> $GITHUB_OUTPUT
          echo "task_ids=$TASK_IDS" >> $GITHUB_OUTPUT

          if [ "$READY_COUNT" -gt 0 ]; then
            echo "action=next_batch" >> $GITHUB_OUTPUT
          else
            echo "action=merge" >> $GITHUB_OUTPUT
          fi

      - name: Post batch progress comment
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const payload = context.payload.client_payload;
            const nextAction = '${{ steps.check.outputs.action }}';
            const readyCount = parseInt('${{ steps.check.outputs.ready_count }}');

            let body = '';
            if (nextAction === 'next_batch') {
              body = `### ✅ Batch Complete\n\n${readyCount} more task(s) ready. Starting next batch...`;
            } else {
              body = `### ✅ All Tasks Complete\n\nMerging task branches and creating PR...`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: payload.issue_number,
              body: body
            });

      - name: Dispatch next batch
        if: steps.check.outputs.action == 'next_batch'
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const payload = context.payload.client_payload;

            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'opencode-batch',
              client_payload: {
                issue_number: payload.issue_number,
                branch: payload.branch
              }
            });

      - name: Dispatch merge
        if: steps.check.outputs.action == 'merge'
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const payload = context.payload.client_payload;
            const taskIds = JSON.parse('${{ steps.check.outputs.task_ids }}');

            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'opencode-merge',
              client_payload: {
                issue_number: payload.issue_number,
                branch: payload.branch,
                task_ids: taskIds
              }
            });
