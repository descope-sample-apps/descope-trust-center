name: OpenCode

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  parse-command:
    if: |
      github.event.issue.pull_request == null &&
      (contains(github.event.comment.body, '/oc ') || 
       contains(github.event.comment.body, '/opencode '))
    runs-on: ubuntu-latest
    outputs:
      command: ${{ steps.parse.outputs.command }}
      is_valid: ${{ steps.parse.outputs.is_valid }}
    steps:
      - name: Parse command
        id: parse
        run: |
          COMMENT='${{ github.event.comment.body }}'
          if echo "$COMMENT" | grep -qiE '/(oc|opencode)\s+plan'; then
            echo "command=plan" >> $GITHUB_OUTPUT
            echo "is_valid=true" >> $GITHUB_OUTPUT
          elif echo "$COMMENT" | grep -qiE '/(oc|opencode)\s+work'; then
            echo "command=work" >> $GITHUB_OUTPUT
            echo "is_valid=true" >> $GITHUB_OUTPUT
          else
            echo "command=unknown" >> $GITHUB_OUTPUT
            echo "is_valid=false" >> $GITHUB_OUTPUT
          fi

  acknowledge:
    needs: parse-command
    if: needs.parse-command.outputs.is_valid == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Add rocket reaction
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

  plan:
    needs: [parse-command, acknowledge]
    if: needs.parse-command.outputs.command == 'plan'
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0

      - name: Setup tools
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          mkdir -p "$HOME/.local/bin"
          gh release download --repo steveyegge/beads --pattern 'beads_*_linux_amd64.tar.gz' --output /tmp/beads.tar.gz
          tar -xzf /tmp/beads.tar.gz -C /tmp && mv /tmp/bd "$HOME/.local/bin/" && rm -rf /tmp/beads.tar.gz /tmp/bd
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
          sed -i 's/^# sync-branch:.*/sync-branch: "beads-sync"/' .beads/config.yaml || echo 'sync-branch: "beads-sync"' >> .beads/config.yaml
          "$HOME/.local/bin/bd" init

      - name: Setup git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create feature branch
        id: branch
        run: |
          BRANCH_NAME="opencode/issue-${{ github.event.issue.number }}"
          git checkout -b "$BRANCH_NAME"
          git push -u origin "$BRANCH_NAME"
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Post planning started comment
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: 'ü§ñ **Planning Started**\n\nAnalyzing issue and breaking down into tasks...'
            });

      - name: Run CI Orchestrator for Planning
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Get issue details
          ISSUE_JSON=$(gh issue view ${{ github.event.issue.number }} --json title,body)
          ISSUE_TITLE=$(echo "$ISSUE_JSON" | jq -r '.title')
          ISSUE_BODY=$(echo "$ISSUE_JSON" | jq -r '.body')
          
          # Run CI Orchestrator in planning mode
          # Note: Use the exact "name" from agent frontmatter, not "id"
          opencode run \
            --agent "CI Orchestrator" \
            --model "opencode/big-pickle" \
            "Execute CI workflow in PLANNING mode for this GitHub issue.

          ## Issue Information
          - Issue Number: ${{ github.event.issue.number }}
          - Issue Title: $ISSUE_TITLE
          - Issue Body:
          $ISSUE_BODY

          ## Environment
          - FEATURE_BRANCH: $BRANCH_NAME
          - MODE: plan

          ## Your Mission
          Execute Stage 1 (Planning) of your workflow:
          
          1. Analyze the issue and break it into atomic tasks
          2. Create epic in Beads: bd create \"Issue #${{ github.event.issue.number }}: $ISSUE_TITLE\"
          3. Create child tasks with detailed descriptions using bd note
          4. Map dependencies between tasks using bd dep add
          5. Sync to beads-sync branch
          6. Post planning summary to GitHub issue
          7. Output task counts for workflow to capture
          
          Store detailed task specifications in Beads notes using this format:
          
          ## Objective
          [What this task accomplishes]
          
          ## Deliverables
          - File: path/to/file.ts
          - Function: functionName
          
          ## Steps
          1. [Implementation step 1]
          2. [Implementation step 2]
          
          ## Acceptance Criteria
          - [ ] Criteria 1
          - [ ] Criteria 2
          
          ## Validation
          \`\`\`bash
          bun run build
          \`\`\`
          
          CI Workers will read these Beads notes for implementation guidance."

       - name: Get task summary
        id: tasks
        run: |
          TOTAL=$(bd list --json 2>/dev/null | jq 'length' || echo '0')
          READY=$(bd ready --json 2>/dev/null | jq 'length' || echo '0')
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "ready=$READY" >> $GITHUB_OUTPUT
          # Also output ready tasks as JSON for workers
          TASK_IDS=$(bd ready --json 2>/dev/null | jq -c '[.[].id]' || echo '[]')
          echo "task_ids=$TASK_IDS" >> $GITHUB_OUTPUT

      - name: Post plan summary
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const total = parseInt('${{ steps.tasks.outputs.total }}') || 0;
            const ready = parseInt('${{ steps.tasks.outputs.ready }}') || 0;

            const body = `## üìã Plan Complete

            **${total} task(s)** created, **${ready}** ready to start (no blockers).

            Tasks will be executed in waves based on dependencies:
            - Ready tasks run in parallel
            - When complete, newly unblocked tasks run
            - Repeat until all done

            ---
            üöÄ Starting first wave with ${ready} task(s)...

            Branch: \`${{ steps.branch.outputs.branch }}\``;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: body
            });

      - name: Commit beads database
        run: |
          bd sync -m "chore: create epic and tasks for issue #${{ github.event.issue.number }}"

      - name: Dispatch batch workers
        if: steps.tasks.outputs.ready > 0
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'opencode-batch',
              client_payload: {
                issue_number: context.payload.issue.number,
                branch: '${{ steps.branch.outputs.branch }}'
              }
            });
            console.log('Dispatched batch workers');

  work:
    needs: [parse-command, acknowledge]
    if: needs.parse-command.outputs.command == 'work'
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0

      - name: Setup tools
        run: |
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH

      - name: Setup git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create feature branch
        id: branch
        run: |
          BRANCH_NAME="opencode/issue-${{ github.event.issue.number }}"
          git checkout -b "$BRANCH_NAME"
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Post work started comment
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: 'ü§ñ **Sisyphus Started**\n\nImplementing changes directly (no planning phase)...'
            });

      - name: Run Sisyphus
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          opencode run \
            --model "opencode/big-pickle" \
            
            "Implement the changes requested in this GitHub Issue.

          ## Instructions
          1. Implement the requested changes
          2. Follow existing code patterns
          3. Run 'bun run build' to verify no errors

          When complete, summarize what was implemented."

      - name: Commit and push
        id: commit
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "feat: implement #${{ github.event.issue.number }}"
            git push -u origin "${{ steps.branch.outputs.branch }}"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.commit.outputs.has_changes == 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ü§ñ ${context.payload.issue.title}`,
              body: `## Summary

            Automated implementation for #${context.payload.issue.number}

            ---

            Closes #${context.payload.issue.number}`,
              head: '${{ steps.branch.outputs.branch }}',
              base: 'main'
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `‚úÖ **Implementation Complete**\n\nPull Request: #${pr.number}`
            });

      - name: No changes comment
        if: steps.commit.outputs.has_changes == 'false'
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: '‚ö†Ô∏è **No Changes Made**\n\nSisyphus did not produce any code changes.'
            });
