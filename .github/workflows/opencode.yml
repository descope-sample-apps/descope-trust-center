name: OpenCode

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write
  models: read

jobs:
  parse-command:
    if: |
      github.event.issue.pull_request == null &&
      (contains(github.event.comment.body, '/oc ') || 
       contains(github.event.comment.body, '/opencode '))
    runs-on: ubuntu-latest
    outputs:
      command: ${{ steps.parse.outputs.command }}
      is_valid: ${{ steps.parse.outputs.is_valid }}
    steps:
      - name: Parse command
        id: parse
        run: |
          COMMENT='${{ github.event.comment.body }}'
          if echo "$COMMENT" | grep -qiE '/(oc|opencode)\s+plan'; then
            echo "command=plan" >> $GITHUB_OUTPUT
            echo "is_valid=true" >> $GITHUB_OUTPUT
          elif echo "$COMMENT" | grep -qiE '/(oc|opencode)\s+work'; then
            echo "command=work" >> $GITHUB_OUTPUT
            echo "is_valid=true" >> $GITHUB_OUTPUT
          else
            echo "command=unknown" >> $GITHUB_OUTPUT
            echo "is_valid=false" >> $GITHUB_OUTPUT
          fi

  acknowledge:
    needs: parse-command
    if: needs.parse-command.outputs.is_valid == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Add rocket reaction
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

  plan:
    needs: [parse-command, acknowledge]
    if: needs.parse-command.outputs.command == 'plan'
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0

      - name: Setup tools
        run: |
          curl -fsSL https://raw.githubusercontent.com/steveyegge/beads/main/scripts/install.sh | bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Fetch Beads database
        run: |
          git fetch origin beads-db:beads-db || true
          git checkout beads-db -- .beads/ 2>/dev/null || true
          bd init --force || bd init

      - name: Create feature branch
        id: branch
        run: |
          BRANCH_NAME="opencode/issue-${{ github.event.issue.number }}"
          git checkout -b "$BRANCH_NAME"
          git push -u origin "$BRANCH_NAME"
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Post planning started comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: 'ü§ñ **Planning Started**\n\nAnalyzing issue and breaking down into tasks...'
            });

      - name: Run Planner-Sisyphus
        id: run-plan
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          curl -fsSL https://opencode.ai/install | bash
          export PATH="$HOME/.opencode/bin:$HOME/.local/bin:$PATH"
          
          mkdir -p ~/.config/opencode
          echo '{"plugin":["oh-my-opencode"]}' > ~/.config/opencode/opencode.json
          
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY=$(cat << 'ISSUE_BODY_EOF'
          ${{ github.event.issue.body }}
          ISSUE_BODY_EOF
          )
          
          opencode run "
          Analyze GitHub Issue #${ISSUE_NUMBER} and break it into atomic, parallelizable tasks.
          
          ## Issue Title
          ${ISSUE_TITLE}
          
          ## Issue Body
          ${ISSUE_BODY}
          
          ## Instructions
          1. Create a beads epic for this issue:
             bd create \"Issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}\" -p 1
          
          2. Create child tasks under the epic using bd create with appropriate priorities (1-4)
          
          3. Add dependencies between tasks using 'bd dep add <task-id> <depends-on-id>'
             - Tasks that can run in parallel should have NO dependencies between them
             - Tasks that must wait for others should declare dependencies
          
          4. After creating all tasks, output the task list
          
          Example dependency structure:
          - bd-abc.1 'Setup types' (no deps - can start immediately)
          - bd-abc.2 'Create component' (no deps - can start immediately)  
          - bd-abc.3 'Add styling' depends on bd-abc.2
          - bd-abc.4 'Write tests' depends on bd-abc.1, bd-abc.2
          - bd-abc.5 'Integration' depends on bd-abc.3, bd-abc.4
          
          Run 'bd list --json' when done.
          " --agent Planner-Sisyphus > plan_output.txt 2>&1 || true
          
          cat plan_output.txt
          
          TASKS=$(bd list --json 2>/dev/null || echo '[]')
          echo "tasks<<EOF" >> $GITHUB_OUTPUT
          echo "$TASKS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Compute dependency batches
        id: batches
        uses: actions/github-script@v7
        with:
          script: |
            const tasks = JSON.parse(process.env.TASKS || '[]');
            
            if (tasks.length === 0) {
              core.setOutput('batches', '[]');
              core.setOutput('batch_count', 0);
              return;
            }
            
            const taskMap = new Map(tasks.map(t => [t.id, t]));
            const completed = new Set();
            const batches = [];
            let remaining = [...tasks];
            
            while (remaining.length > 0) {
              const batch = remaining.filter(t => {
                const deps = t.dependencies || t.blocked_by || [];
                return deps.every(d => completed.has(d));
              });
              
              if (batch.length === 0) {
                console.log('Circular dependency detected, adding remaining as final batch');
                batches.push(remaining);
                break;
              }
              
              batches.push(batch);
              batch.forEach(t => completed.add(t.id));
              remaining = remaining.filter(t => !completed.has(t.id));
            }
            
            console.log(`Created ${batches.length} batches from ${tasks.length} tasks`);
            batches.forEach((b, i) => {
              console.log(`Batch ${i + 1}: ${b.map(t => t.id).join(', ')}`);
            });
            
            core.setOutput('batches', JSON.stringify(batches));
            core.setOutput('batch_count', batches.length);
        env:
          TASKS: ${{ steps.run-plan.outputs.tasks }}

      - name: Post plan summary
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const batches = JSON.parse(process.env.BATCHES || '[]');
            const batchCount = batches.length;
            const taskCount = batches.flat().length;
            
            let batchList = '';
            if (batchCount > 0) {
              batchList = batches.map((batch, i) => {
                const tasks = batch.map(t => `  - \`${t.id}\` ${t.title || t.summary || ''}`).join('\n');
                return `**Batch ${i + 1}** (${batch.length} task${batch.length > 1 ? 's' : ''}):\n${tasks}`;
              }).join('\n\n');
            } else {
              batchList = '_No tasks created_';
            }
            
            const body = `## üìã Plan Complete

            **${taskCount} task(s)** organized into **${batchCount} batch(es)** based on dependencies.

            ### Execution Plan
            ${batchList}

            ---
            üöÄ Starting batch 1...
            
            Branch: \`${process.env.BRANCH}\``;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: body
            });
        env:
          BATCHES: ${{ steps.batches.outputs.batches }}
          BRANCH: ${{ steps.branch.outputs.branch }}

      - name: Commit beads to beads-db branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          bd sync -m "chore: create epic and tasks for issue #${{ github.event.issue.number }}"

      - name: Dispatch first batch
        if: steps.batches.outputs.batch_count > 0
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const batches = JSON.parse(process.env.BATCHES || '[]');
            
            if (batches.length === 0) {
              console.log('No batches to dispatch');
              return;
            }
            
            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'opencode-batch',
              client_payload: {
                issue_number: context.payload.issue.number,
                branch: process.env.BRANCH,
                batch_index: 0,
                batches: batches
              }
            });
            
            console.log(`Dispatched batch 1 with ${batches[0].length} task(s)`);
        env:
          BATCHES: ${{ steps.batches.outputs.batches }}
          BRANCH: ${{ steps.branch.outputs.branch }}

  work:
    needs: [parse-command, acknowledge]
    if: needs.parse-command.outputs.command == 'work'
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0

      - name: Setup tools
        run: |
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Create feature branch
        id: branch
        run: |
          BRANCH_NAME="opencode/issue-${{ github.event.issue.number }}"
          git checkout -b "$BRANCH_NAME"
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Post work started comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: 'ü§ñ **Sisyphus Started**\n\nImplementing changes directly (no planning phase)...'
            });

      - name: Run Sisyphus
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          curl -fsSL https://opencode.ai/install | bash
          export PATH="$HOME/.opencode/bin:$HOME/.local/bin:$PATH"
          
          mkdir -p ~/.config/opencode
          echo '{"plugin":["oh-my-opencode"]}' > ~/.config/opencode/opencode.json
          
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY=$(cat << 'ISSUE_BODY_EOF'
          ${{ github.event.issue.body }}
          ISSUE_BODY_EOF
          )
          
          opencode run "
          Implement the changes requested in GitHub Issue #${ISSUE_NUMBER}.
          
          ## Issue Title
          ${ISSUE_TITLE}
          
          ## Issue Body
          ${ISSUE_BODY}
          
          ## Instructions
          1. Implement the requested changes
          2. Follow existing code patterns
          3. Run 'bun run build' to verify no errors
          
          When complete, summarize what was implemented.
          " || true

      - name: Commit and push
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "feat: implement #${{ github.event.issue.number }}"
            git push -u origin "${{ steps.branch.outputs.branch }}"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.commit.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ü§ñ ${context.payload.issue.title}`,
              body: `## Summary
            
            Automated implementation for #${context.payload.issue.number}
            
            ---
            
            Closes #${context.payload.issue.number}`,
              head: process.env.BRANCH,
              base: 'main'
            });
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `‚úÖ **Implementation Complete**\n\nPull Request: #${pr.number}`
            });
        env:
          BRANCH: ${{ steps.branch.outputs.branch }}

      - name: No changes comment
        if: steps.commit.outputs.has_changes == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: '‚ö†Ô∏è **No Changes Made**\n\nSisyphus did not produce any code changes.'
            });
