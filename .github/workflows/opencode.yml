name: OpenCode

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  parse-command:
    if: |
      github.event.issue.pull_request == null &&
      (contains(github.event.comment.body, '/oc ') || 
       contains(github.event.comment.body, '/opencode '))
    runs-on: ubuntu-latest
    outputs:
      command: ${{ steps.parse.outputs.command }}
      is_valid: ${{ steps.parse.outputs.is_valid }}
    steps:
      - name: Parse command
        id: parse
        run: |
          COMMENT='${{ github.event.comment.body }}'
          if echo "$COMMENT" | grep -qiE '/(oc|opencode)\s+plan'; then
            echo "command=plan" >> $GITHUB_OUTPUT
            echo "is_valid=true" >> $GITHUB_OUTPUT
          elif echo "$COMMENT" | grep -qiE '/(oc|opencode)\s+work'; then
            echo "command=work" >> $GITHUB_OUTPUT
            echo "is_valid=true" >> $GITHUB_OUTPUT
          else
            echo "command=unknown" >> $GITHUB_OUTPUT
            echo "is_valid=false" >> $GITHUB_OUTPUT
          fi

  acknowledge:
    needs: parse-command
    if: needs.parse-command.outputs.is_valid == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Add rocket reaction
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

  plan:
    needs: [parse-command, acknowledge]
    if: needs.parse-command.outputs.command == 'plan'
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0

      - name: Setup tools
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          mkdir -p "$HOME/.local/bin"
          gh release download --repo steveyegge/beads --pattern 'beads_*_linux_amd64.tar.gz' --output /tmp/beads.tar.gz
          tar -xzf /tmp/beads.tar.gz -C /tmp && mv /tmp/bd "$HOME/.local/bin/" && rm -rf /tmp/beads.tar.gz /tmp/bd
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
          "$HOME/.local/bin/bd" init
          sed -i 's/^# sync-branch:.*/sync-branch: "beads-sync"/' .beads/config.yaml || echo 'sync-branch: "beads-sync"' >> .beads/config.yaml

      - name: Setup git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create feature branch
        id: branch
        run: |
          BRANCH_NAME="opencode/issue-${{ github.event.issue.number }}"
          git checkout -b "$BRANCH_NAME"
          git push -u origin "$BRANCH_NAME"
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Post planning started comment
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: 'ü§ñ **Planning Started**\n\nAnalyzing issue and breaking down into tasks...'
            });

      - name: Run Planner-Sisyphus
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          opencode run \
            --model "opencode/big-pickle" \
            --agent "Planner-Sisyphus" \
            "Analyze this GitHub Issue and break it into atomic, parallelizable tasks.

          ## Instructions
          1. Create a beads epic for this issue:
             bd create \"Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}\" -p 1

          2. Create child tasks under the epic using bd create with appropriate priorities (1-4)

          3. Add dependencies between tasks using 'bd dep add <task-id> <depends-on-id>'
             - Tasks that can run in parallel should have NO dependencies between them
             - Tasks that must wait for others should declare dependencies

          4. After creating all tasks, output the task list

          Example dependency structure:
          - bd-abc.1 'Setup types' (no deps - can start immediately)
          - bd-abc.2 'Create component' (no deps - can start immediately)  
          - bd-abc.3 'Add styling' depends on bd-abc.2
          - bd-abc.4 'Write tests' depends on bd-abc.1, bd-abc.2
          - bd-abc.5 'Integration' depends on bd-abc.3, bd-abc.4

          Run 'bd list --json' when done."

      - name: Get task summary
        id: tasks
        run: |
          TOTAL=$(bd list --json 2>/dev/null | jq 'length' || echo '0')
          READY=$(bd ready --json 2>/dev/null | jq 'length' || echo '0')
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "ready=$READY" >> $GITHUB_OUTPUT

      - name: Post plan summary
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const total = parseInt('${{ steps.tasks.outputs.total }}') || 0;
            const ready = parseInt('${{ steps.tasks.outputs.ready }}') || 0;

            const body = `## üìã Plan Complete

            **${total} task(s)** created, **${ready}** ready to start (no blockers).

            Tasks will be executed in waves based on dependencies:
            - Ready tasks run in parallel
            - When complete, newly unblocked tasks run
            - Repeat until all done

            ---
            üöÄ Starting first wave with ${ready} task(s)...

            Branch: \`${{ steps.branch.outputs.branch }}\``;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: body
            });

      - name: Commit beads database
        run: |
          bd sync -m "chore: create epic and tasks for issue #${{ github.event.issue.number }}"

      - name: Dispatch batch workers
        if: steps.tasks.outputs.ready > 0
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'opencode-batch',
              client_payload: {
                issue_number: context.payload.issue.number,
                branch: '${{ steps.branch.outputs.branch }}'
              }
            });
            console.log('Dispatched batch workers');

  work:
    needs: [parse-command, acknowledge]
    if: needs.parse-command.outputs.command == 'work'
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0

      - name: Setup tools
        run: |
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH

      - name: Setup git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create feature branch
        id: branch
        run: |
          BRANCH_NAME="opencode/issue-${{ github.event.issue.number }}"
          git checkout -b "$BRANCH_NAME"
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Post work started comment
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: 'ü§ñ **Sisyphus Started**\n\nImplementing changes directly (no planning phase)...'
            });

      - name: Run Sisyphus
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          opencode run \
            --model "opencode/big-pickle" \
            "Implement the changes requested in this GitHub Issue.

          ## Instructions
          1. Implement the requested changes
          2. Follow existing code patterns
          3. Run 'bun run build' to verify no errors

          When complete, summarize what was implemented."

      - name: Commit and push
        id: commit
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "feat: implement #${{ github.event.issue.number }}"
            git push -u origin "${{ steps.branch.outputs.branch }}"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.commit.outputs.has_changes == 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ü§ñ ${context.payload.issue.title}`,
              body: `## Summary

            Automated implementation for #${context.payload.issue.number}

            ---

            Closes #${context.payload.issue.number}`,
              head: '${{ steps.branch.outputs.branch }}',
              base: 'main'
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `‚úÖ **Implementation Complete**\n\nPull Request: #${pr.number}`
            });

      - name: No changes comment
        if: steps.commit.outputs.has_changes == 'false'
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: '‚ö†Ô∏è **No Changes Made**\n\nSisyphus did not produce any code changes.'
            });
