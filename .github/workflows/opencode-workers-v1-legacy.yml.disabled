name: OpenCode Batch Workers

on:
  repository_dispatch:
    types: [opencode-batch]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number"
        required: true
        type: number
      branch:
        description: "Feature branch name"
        required: true
        type: string

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  coordinator:
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Set payload variables
        id: payload
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "issue_number=${{ inputs.issue_number }}" >> $GITHUB_OUTPUT
            echo "branch=${{ inputs.branch }}" >> $GITHUB_OUTPUT
          else
            echo "issue_number=${{ github.event.client_payload.issue_number }}" >> $GITHUB_OUTPUT
            echo "branch=${{ github.event.client_payload.branch }}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout feature branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.payload.outputs.branch }}
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0

      - name: Setup tools
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          mkdir -p "$HOME/.local/bin"

          # Install beads
          gh release download --repo steveyegge/beads --pattern 'beads_*_linux_amd64.tar.gz' --output /tmp/beads.tar.gz
          tar -xzf /tmp/beads.tar.gz -C /tmp && mv /tmp/bd "$HOME/.local/bin/" && rm -rf /tmp/beads.tar.gz /tmp/bd
          echo "$HOME/.local/bin" >> $GITHUB_PATH

          # Install bun
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

          # Install opencode
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH

          # Install bun dependencies
          $HOME/.bun/bin/bun install

      - name: Setup git and beads
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Configure beads sync branch
          sed -i 's/^# sync-branch:.*/sync-branch: "beads-sync"/' .beads/config.yaml || echo 'sync-branch: "beads-sync"' >> .beads/config.yaml

          # Initialize and sync beads
          "$HOME/.local/bin/bd" init
          "$HOME/.local/bin/bd" sync

      - name: Post started comment
        id: comment
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const { data: comment } = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ steps.payload.outputs.issue_number }}'),
              body: '### üîÑ Implementation Started\n\nCI Orchestrator is executing all tasks in parallel waves, merging branches, and will create a PR when complete...'
            });
            return comment.id;
          result-encoding: string

      - name: Run CI Orchestrator
        id: orchestrator
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          FEATURE_BRANCH: ${{ steps.payload.outputs.branch }}
          ISSUE_NUMBER: ${{ steps.payload.outputs.issue_number }}
          STATUS_COMMENT_ID: ${{ steps.comment.outputs.result }}
        run: |
          # Run CI Orchestrator agent
          # Note: Use the exact "name" from agent frontmatter, not "id"
          opencode run \
            --agent "CI Orchestrator" \
            --model "opencode/big-pickle" \
            "Execute complete CI workflow for this GitHub issue.
          
          ## Environment Variables
          - ISSUE_NUMBER: $ISSUE_NUMBER
          - FEATURE_BRANCH: $FEATURE_BRANCH
          - STATUS_COMMENT_ID: $STATUS_COMMENT_ID (update this comment, don't create new ones!)
          - MODE: execute (tasks already created from planning stage)
          
          ## Your Mission
          Execute your complete workflow:
          1. Stage 0: Initialize (verify tools, sync Beads)
          2. Stage 2: Wave Execution (skip planning - tasks already exist)
             - Query bd ready for tasks
             - Spawn CI Worker subagents in parallel
             - Track progress and handle failures
          3. Stage 3: Merge all task branches
          4. Stage 4: Create pull request
          5. Stage 5: Clean up task branches
          
          ## Expected Output
          When complete:
          \`\`\`
          EPIC_COMPLETE: true
          PR_NUMBER: <number>
          \`\`\`
          
          On failure:
          \`\`\`
          EPIC_COMPLETE: false
          ERROR: <description>
          STAGE_FAILED: <stage_name>
          \`\`\`" 2>&1 | tee /tmp/orchestrator-output.txt

          # Parse output for results
          if grep -q "EPIC_COMPLETE: true" /tmp/orchestrator-output.txt; then
            echo "epic_complete=true" >> $GITHUB_OUTPUT
            # Get last occurrence of PR_NUMBER (in case of multiple outputs) and extract only the number
            PR_NUM=$(grep "PR_NUMBER:" /tmp/orchestrator-output.txt | tail -1 | sed 's/.*PR_NUMBER: *//' | tr -d ' ' | grep -o '[0-9]*')
            if [ -n "$PR_NUM" ]; then
              echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
            fi
          else
            echo "epic_complete=false" >> $GITHUB_OUTPUT
          fi

      - name: Update comment with result
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const epicComplete = '${{ steps.orchestrator.outputs.epic_complete }}' === 'true';
            const prNumber = '${{ steps.orchestrator.outputs.pr_number }}';
            const commentId = parseInt('${{ steps.comment.outputs.result }}');

            let body;
            if (epicComplete && prNumber) {
              body = `### üéâ Implementation Complete\n\nAll tasks implemented and merged.\n\n**Pull Request:** #${prNumber}`;
            } else if (epicComplete) {
              body = '### ‚úÖ All Tasks Complete\n\nAll tasks have been implemented and merged. Check for the PR.';
            } else {
              body = '### ‚ö†Ô∏è Implementation Finished with Issues\n\nSome tasks may have failed. Check workflow logs for details.';
            }

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });
